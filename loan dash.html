<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Management Dashboard</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsRwHSbZUL9VkZiyx9gDRgblotaVAHHiQ",
      authDomain: "sample-329e1.firebaseapp.com",
      projectId: "sample-329e1",
      storageBucket: "sample-329e1.appspot.com",
      messagingSenderId: "880950005868",
      appId: "1:880950005868:web:296a55912477a4b4a44849"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.toggleSidebar = function() {
      document.getElementById("sidebar").classList.toggle("active");
      document.getElementById("content").classList.toggle("active");
    }

    window.logout = async function() {
      await signOut(auth);
      localStorage.removeItem("userPhone");
      window.location.href = "log.html";
    }

    window.applyLoan = function() {
      window.location.href = "cal.html";
    }

    // Format phone number to show only "07" and last 3 digits
    window.formatPhoneNumber = function(phone) {
      if (!phone) return "N/A";
      // Ensure phone is a string
      phone = String(phone);
      // Extract last 3 digits
      const lastThree = phone.slice(-3);
      return `07*** ***${lastThree}`;
    }

    // Simulate recent loan approvals data
    window.generateRecentApprovals = function() {
      const firstNames = ['John', 'Mary', 'David', 'Sarah', 'James', 'Linda', 'Michael', 'Susan', 'Robert', 'Karen'];
      const lastInitials = ['M.', 'K.', 'J.', 'A.', 'W.', 'N.', 'T.', 'L.', 'B.', 'R.'];
      const amounts = ['5,000', '7,500', '10,000', '12,500', '15,000', '17,500', '20,000'];
      
      const approvals = [];
      const now = new Date();
      
      for (let i = 0; i < 8; i++) {
        const randomTime = new Date(now.getTime() - Math.random() * 24 * 60 * 60 * 1000);
        const hours = randomTime.getHours().toString().padStart(2, '0');
        const minutes = randomTime.getMinutes().toString().padStart(2, '0');
        
        approvals.push({
          name: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastInitials[Math.floor(Math.random() * lastInitials.length)]}`,
          phone: `07${Math.floor(Math.random() * 90000000 + 10000000)}`,
          amount: amounts[Math.floor(Math.random() * amounts.length)],
          time: `${hours}:${minutes}`
        });
      }
      
      return approvals;
    }

    window.displayRecentApprovals = function() {
      const approvals = generateRecentApprovals();
      const container = document.getElementById('recentApprovals');
      container.innerHTML = '';
      
      approvals.forEach(approval => {
        const div = document.createElement('div');
        div.className = 'approval-item';
        div.innerHTML = `
          <div class="approval-avatar">${approval.name.charAt(0)}</div>
          <div class="approval-details">
            <div class="approval-name">${approval.name}</div>
            <div class="approval-phone">${formatPhoneNumber(approval.phone)}</div>
          </div>
          <div class="approval-amount">Ksh ${approval.amount}</div>
          <div class="approval-time">${approval.time}</div>
        `;
        container.appendChild(div);
      });
    }

    window.loadUserData = function() {
      const phone = localStorage.getItem("userPhone");
      if (!phone) {
        window.location.href = "log.html";
        return;
      }

      const userRef = doc(db, "users", phone);

      // Real-time profile
      onSnapshot(userRef, (userDoc) => {
        if (userDoc.exists()) {
          const data = userDoc.data();
          document.getElementById("userName").textContent = data.name;
          document.getElementById("userEmail").textContent = data.email;
          document.getElementById("userPhone").textContent = formatPhoneNumber(data.phone);
        }
      });

      // Real-time loan history
      const loansQuery = query(collection(db, "loans"), where("phone", "==", phone));
      onSnapshot(loansQuery, (loanSnap) => {
        let rows = "";
        loanSnap.forEach(docSnap => {
          const loan = docSnap.data();
          rows += `<tr>
            <td>Ksh ${loan.amount}</td>
            <td>${loan.status}</td>
            <td>${loan.date}</td>
          </tr>`;
        });
        document.getElementById("loanHistory").innerHTML = rows || `<tr><td colspan="3">No loan records found.</td></tr>`;
      });

      // Real-time notifications
      const notifQuery = query(collection(db, "notifications"), where("phone", "==", phone));
      onSnapshot(notifQuery, (notifSnap) => {
        let notifHTML = "";
        notifSnap.forEach(docSnap => {
          const note = docSnap.data();
          notifHTML += `<div class="notification">📩 ${note.message}</div>`;
        });
        document.getElementById("notifications").innerHTML = notifHTML || `<div class="notification">📢 Welcome to your Loan Dashboard!</div>`;
      });
      
      // Display recent approvals
      displayRecentApprovals();
      
      // Update recent approvals every 3 minutes (180000 ms)
      setInterval(displayRecentApprovals, 180000);
    }

    window.addEventListener("DOMContentLoaded", loadUserData);
  </script>

  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #1abc9c;
      --warning-color: #f39c12;
      --success-color: #27ae60;
      --light-color: #f5f7fa;
      --dark-color: #1a252f;
      --text-color: #333;
      --text-light: #7f8c8d;
      --border-radius: 8px;
      --box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      --transition: all 0.3s ease;
    }

    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: "Segoe UI", "Roboto", sans-serif; 
      overflow: hidden; 
      color: var(--text-color);
    }
    
    body { 
      display: flex; 
      background-color: var(--light-color);
    }
    
    .sidebar {
      width: 240px; 
      background: linear-gradient(to bottom, var(--primary-color), var(--dark-color)); 
      color: #fff;
      height: 100vh; 
      position: fixed; 
      left: -240px; 
      top: 0; 
      transition: var(--transition); 
      padding-top: 70px; 
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    
    .sidebar.active { 
      left: 0; 
    }
    
    .sidebar a { 
      display: flex; 
      align-items: center;
      padding: 14px 20px; 
      color: #fff; 
      text-decoration: none; 
      border-bottom: 1px solid rgba(255,255,255,0.1); 
      transition: var(--transition);
      font-size: 15px;
    }
    
    .sidebar a:hover { 
      background: rgba(255,255,255,0.1); 
      padding-left: 25px;
    }
    
    .sidebar a i {
      margin-right: 12px;
      font-size: 18px;
    }
    
    .toggle-btn { 
      position: absolute; 
      left: 15px; 
      top: 15px; 
      font-size: 24px; 
      cursor: pointer; 
      color: #fff; 
      z-index: 1001;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      padding: 5px 10px;
    }
    
    .content { 
      margin-left: 0; 
      flex: 1; 
      transition: var(--transition); 
      height: 100vh; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
    }
    
    .content.active { 
      margin-left: 240px; 
    }
    
    header { 
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); 
      color: #fff; 
      padding: 18px 25px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-shrink: 0; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    header h1 { 
      margin: 0; 
      font-size: 24px; 
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    header h1 i {
      margin-right: 10px;
    }
    
    .container { 
      padding: 25px; 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      grid-gap: 25px; 
      flex: 1; 
    }
    
    .card { 
      background: #fff; 
      padding: 25px; 
      border-radius: var(--border-radius); 
      box-shadow: var(--box-shadow); 
      display: flex; 
      flex-direction: column; 
      transition: var(--transition);
      border-top: 4px solid var(--secondary-color);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .card h2 { 
      margin-top: 0; 
      font-size: 18px; 
      color: var(--primary-color); 
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 12px;
      display: flex;
      align-items: center;
    }
    
    .card h2 i {
      margin-right: 10px;
      color: var(--secondary-color);
    }
    
    .profile p, .loan-info p { 
      margin: 8px 0; 
      font-size: 15px; 
      display: flex;
      justify-content: space-between;
    }
    
    .profile p strong, .loan-info p strong {
      color: var(--primary-color);
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px; 
      font-size: 14px; 
    }
    
    table th, table td { 
      padding: 12px; 
      border-bottom: 1px solid #ddd; 
      text-align: left; 
    }
    
    table th { 
      background: #f0f2f5; 
      font-weight: 600;
      color: var(--primary-color);
    }
    
    table tr:last-child td {
      border-bottom: none;
    }
    
    .notification { 
      font-size: 14px; 
      padding: 12px; 
      background: #fdf5e6; 
      border-left: 4px solid var(--warning-color); 
      margin: 8px 0; 
      border-radius: 6px; 
      display: flex;
      align-items: center;
    }
    
    .notification i {
      margin-right: 8px;
    }
    
    .offers { 
      background: linear-gradient(135deg, var(--accent-color), #16a085); 
      color: #fff; 
      padding: 25px; 
      border-radius: var(--border-radius); 
      text-align: center; 
      box-shadow: var(--box-shadow); 
      margin: 25px; 
      flex-shrink: 0; 
    }
    
    .offers h2 { 
      color: #fff; 
      font-size: 22px; 
      margin-bottom: 15px; 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .offers h2 i {
      margin-right: 10px;
    }
    
    .offers ul { 
      list-style: none; 
      padding: 0; 
      margin: 0 0 20px 0; 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }
    
    .offers ul li { 
      margin: 8px 0; 
      font-size: 15px; 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .offers ul li i {
      margin-right: 8px;
    }
    
    .offers button { 
      background: var(--warning-color); 
      border: none; 
      padding: 12px 30px; 
      border-radius: var(--border-radius); 
      color: #fff; 
      font-weight: 600; 
      cursor: pointer; 
      font-size: 16px; 
      transition: var(--transition);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .offers button:hover { 
      background: #e67e22; 
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }
    
    /* Recent Approvals Section */
    .recent-approvals {
      background: #fff;
      margin: 0 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
    }
    
    .recent-approvals h2 {
      display: flex;
      align-items: center;
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 15px;
      margin-top: 0;
    }
    
    .recent-approvals h2 i {
      margin-right: 10px;
      color: var(--secondary-color);
    }
    
    .approvals-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
      margin-top: 18px;
    }
    
    .approval-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: var(--border-radius);
      transition: var(--transition);
      border-left: 4px solid var(--success-color);
    }
    
    .approval-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    
    .approval-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary-color), #2980b9);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
      flex-shrink: 0;
      font-size: 18px;
    }
    
    .approval-details {
      flex: 1;
    }
    
    .approval-name {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 15px;
    }
    
    .approval-phone {
      font-size: 13px;
      color: var(--text-light);
    }
    
    .approval-amount {
      font-weight: bold;
      color: var(--success-color);
      margin-left: 10px;
      font-size: 15px;
    }
    
    .approval-time {
      font-size: 12px;
      color: var(--text-light);
      margin-left: 10px;
      background: rgba(0,0,0,0.05);
      padding: 4px 8px;
      border-radius: 12px;
    }
    
    @media (max-width: 768px) { 
      .container { 
        grid-template-columns: 1fr; 
        padding: 15px;
      }
      .approvals-container {
        grid-template-columns: 1fr;
      }
      .recent-approvals, .offers {
        margin: 0 15px;
      }
      header {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
<a href="/notification.html" style="
  position: fixed;
  top: 10px;
  right: 10px;
  display: inline-block;
  font-size: 24px;
  text-decoration: none;
  color: black;
  z-index: 1000;
">
  🔔
  <span style="
    position: absolute;
    top: -8px;
    right: -8px;
    padding: 2px 6px;
    border-radius: 50%;
    background: red;
    color: white;
    font-size: 12px;
    font-weight: bold;
  ">0</span>
</a>
  <div class="sidebar" id="sidebar">
    <a href="loan dash.html"><i>🏠</i> Dashboard</a>
    <a href="cal.html"><i>📊</i> My Eligibility</a>
    <a href="notification.html"><i>🔔</i> Notifications</a>
<a href="#" onclick="openTerms()"><i>📑</i> Terms & Conditions</a>
<a href="referral.html"><i>👥</i> Referral</a>
    <a href="#" onclick="logout()"><i>🚪</i> Logout</a>
  </div>

  <div class="content" id="content">
    <header>
      <span class="toggle-btn" onclick="toggleSidebar()">☰</span>
      <h1><i>💼</i> Loan Management Dashboard</h1>
    </header>

    <div class="container">
      <div class="card profile">
        <h2><i>👤</i> User Profile</h2>
        <p><strong>Name:</strong> <span id="userName">Loading...</span></p>
        <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
        <p><strong>Phone:</strong> <span id="userPhone">Loading...</span></p>
      </div>
      <div class="card loan-info">
        <h2><i>💰</i> Loan Summary</h2>
        <p><strong>Active Loan:</strong> <span id="activeLoan">None</span></p>
        <p><strong>Outstanding Balance:</strong> <span id="outstanding">0</span></p>
        <p><strong>Next Due Date:</strong> <span id="dueDate">N/A</span></p>
      </div>
      <div class="card history">
        <h2><i>📋</i> Loan History</h2>
        <table>
          <thead>
            <tr><th>Amount</th><th>Status</th><th>Date</th></tr>
          </thead>
          <tbody id="loanHistory">
            <tr><td colspan="3">No loan records found.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card notifications">
        <h2><i>🔔</i> Notifications</h2>
        <div id="notifications">
          <div class="notification"><i>📢</i> Welcome to your Loan Dashboard!</div>
        </div>
      </div>
    </div>

    <!-- Recent Loan Approvals Section -->
    <div class="recent-approvals">
      <h2><i>🎉</i> Recent Loan Approvals</h2>
      <p>See who just got approved for a loan. Don't miss out!</p>
      <div class="approvals-container" id="recentApprovals">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>

    <div class="offers">
      <h2><i>✅</i> Why Choose Our Loans?</h2>
      <ul>
        <li><i>✅</i> No CRB Check – Everyone qualifies</li>
        <li><i>✅</i> Borrow up to <strong>Ksh 20,000</strong></li>
        <li><i>✅</i> Affordable interest rates as low as <strong>5%</strong></li>
        <li><i>✅</i> Instant approval in minutes</li>
      </ul>
      <button onclick="applyLoan()">Check Eligibility Now</button>
    </div>
  </div>
</body>
</html>